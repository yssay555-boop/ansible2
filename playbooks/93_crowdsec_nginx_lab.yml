---
- name: "03) CrowdSec + Nginx: 로그 기반 보안 탐지(실습용)"
  hosts: localhost
  connection: local
  become: true
  vars:
    nginx_container: "lab-nginx"
    crowdsec_container: "lab-crowdsec"
  tasks:
    - name: Skip if lab disabled
      ansible.builtin.meta: end_play
      when: not enable_crowdsec_lab | bool

    - name: Ensure directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ lab_root }}"
        - "{{ nginx_logs_dir }}"
        - "{{ lab_root }}/crowdsec"

    - name: Place Nginx config
      ansible.builtin.copy:
        src: "../files/nginx/default.conf"
        dest: "{{ lab_root }}/nginx-default.conf"
        mode: "0644"

    - name: Place CrowdSec acquisitions config
      ansible.builtin.copy:
        src: "../files/crowdsec/acquis.yaml"
        dest: "{{ lab_root }}/crowdsec/acquis.yaml"
        mode: "0644"

    - name: Start Nginx container (logs bind-mounted)
      community.docker.docker_container:
        name: "{{ nginx_container }}"
        image: "nginx:latest"
        state: started
        restart_policy: unless-stopped
        ports:
          - "18080:80"
        volumes:
          - "{{ nginx_logs_dir }}:/var/log/nginx"
          - "{{ lab_root }}/nginx-default.conf:/etc/nginx/conf.d/default.conf:ro"

    - name: Start CrowdSec container (reads nginx logs)
      community.docker.docker_container:
        name: "{{ crowdsec_container }}"
        image: "crowdsecurity/crowdsec:latest"
        state: started
        restart_policy: unless-stopped
        # CrowdSec 컨테이너 내부에서 /var/log/nginx 를 읽게끔 동일 마운트
        volumes:
          - "{{ nginx_logs_dir }}:/var/log/nginx:ro"
          - "{{ lab_root }}/crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml:ro"
          - "{{ lab_root }}/crowdsec/data:/var/lib/crowdsec/data"
          - "{{ lab_root }}/crowdsec/config:/etc/crowdsec"
        env:
          TZ: "Asia/Seoul"

    - name: Show lab endpoints
      ansible.builtin.debug:
        msg:
          - "Nginx is running on http://localhost:8080"
          - "Try generating logs: curl http://localhost:8080/ , /notfound"
          - "CrowdSec check: docker exec -it {{ crowdsec_container }} cscli metrics"
          - "Alerts: docker exec -it {{ crowdsec_container }} cscli alerts list"
